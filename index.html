<!DOCTYPE html><html lang="ja"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Body Condition</title>
<style>
  html,body{margin:0;height:100%;background:#0b0d10;color:#e6e9ef;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif}
  #app{position:fixed;inset:0;display:grid;grid-template-rows:1fr auto}
  #stage{position:relative;touch-action:none}
  canvas{display:block;width:100%;height:100%}
  #hud{display:flex;gap:.5rem;align-items:center;padding:.5rem .75rem;background:#0f1217;border-top:1px solid #1b222c;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid #263043;background:#131821;color:#e6e9ef;padding:.5rem .7rem;border-radius:.6rem;font-size:.9rem}
  .btn.primary{background:#1a2a4a;border-color:#2e4d8a}
  .seg{display:flex;border:1px solid #263043;border-radius:.6rem;overflow:hidden}
  .seg button{border:0;background:#0f1217;padding:.45rem .6rem;color:#b7c0cd}
  .seg button.active{background:#1a2a4a;color:#fff}
  #lang{margin-left:auto}
  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:5.5rem;padding:.6rem .8rem;background:#111723;border:1px solid #24314a;border-radius:.6rem;display:none;z-index:10}
  #calendarPanel{position:fixed;inset:auto 0 0 0;background:#0f1217;border-top:1px solid #1b222c;transform:translateY(100%);transition:transform .25s ease;z-index:9}
  #calendarPanel.open{transform:translateY(0)}
  #calHeader{display:flex;align-items:center;justify-content:space-between;padding:.6rem .75rem;border-bottom:1px solid #1b222c}
  #calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:.25rem;padding:.5rem}
  .calCell{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;border:1px solid #1b222c;border-radius:.4rem;font-size:.9rem;color:#b7c0cd}
  .calCell.today{outline:2px solid #2e7dd7}.calCell.hasData{background:#132235;color:#e6f0ff}
  #help{position:fixed;top:.5rem;left:.5rem;right:.5rem;display:flex;justify-content:space-between;pointer-events:none}
  .pill{pointer-events:auto;background:rgba(16,20,28,.6);backdrop-filter:blur(6px);padding:.35rem .55rem;border:1px solid rgba(60,80,110,.5);border-radius:999px;font-size:.8rem;color:#c8d1de}
</style>
</head><body>
<div id="app">
  <div id="stage"></div>
  <div id="hud">
    <div class="seg" id="viewSeg"><button data-view="front" class="active">前面</button><button data-view="back">背面</button></div>
    <button class="btn" id="undoBtn">UNDO</button><button class="btn" id="redoBtn">REDO</button>
    <div class="seg"><button class="btn" id="bothBtn">左右同時</button><button class="btn" id="mirrorBtn">反対側に反映</button></div>
    <button class="btn" id="calendarBtn">カレンダー</button><button class="btn" id="shotBtn">PNG</button>
    <div class="seg"><button class="btn" id="exportBtn">JSON出力</button><button class="btn" id="importBtn">JSON取込</button></div>
    <div class="seg" id="lang"><button data-lang="ja" class="active">日本語</button><button data-lang="en">EN</button></div>
  </div>
</div>
<div id="help"><div class="pill">タップ＝強度切替（弱→中→強→オフ）</div><div class="pill">2指：ドラッグ=パン／ピンチ=ズーム</div></div>
<div id="toast"></div>
<div id="calendarPanel"><div id="calHeader">
  <button class="btn" id="calPrev">◀</button><div><div id="calTitle" style="text-align:center;font-weight:600"></div>
  <div style="text-align:center;font-size:.85rem;color:#9aa6b2">タップでその日の状態を復元</div></div><button class="btn" id="calNext">▶</button>
</div><div id="calGrid"></div></div>

<!-- Three.js（CDN。ブロックされる環境なら後でローカル同梱に切替） -->
<!-- three.js 本体 -->
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>

<!-- OrbitControls -->
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/controls/OrbitControls.js"></script>
<script>
const L10N={ja:{regions:{head:"頭部",neck:"頸",chest:"胸部",upperBack:"背上部",lowerBack:"背下部",abdomen:"腹部",
shoulderL:"左肩",shoulderR:"右肩",upperArmF_L:"左上腕前",upperArmF_R:"右上腕前",upperArmB_L:"左上腕後",upperArmB_R:"右上腕後",
forearmF_L:"左前腕前",forearmF_R:"右前腕前",forearmB_L:"左前腕後",forearmB_R:"右前腕後",handL:"左手",handR:"右手",
gluteL:"左殿部",gluteR:"右殿部",thighF_L:"左大腿前",thighF_R:"右大腿前",thighB_L:"左大腿後",thighB_R:"右大腿後",
thighM_L:"左大腿内側",thighM_R:"右大腿内側",thighL_L:"左大腿外側",thighL_R:"右大腿外側",
calfF_L:"左下腿前",calfF_R:"右下腿前",calfB_L:"左下腿後",calfB_R:"右下腿後",
itb_L:"左腸脛靭帯域",itb_R:"右腸脛靭帯域",achilles_L:"左アキレス腱域",achilles_R:"右アキレス腱域",
footSole_L:"左足底",footSole_R:"右足底",footDorsum_L:"左足背",footDorsum_R:"右足背",
hipRing_L:"左股関節周囲",hipRing_R:"右股関節周囲",kneeRing_L:"左膝周囲",kneeRing_R:"右膝周囲"},
toastSaved:"保存しました",toastLoaded:"読み込みました",front:"前面",back:"背面"},
en:{regions:{head:"Head",neck:"Neck",chest:"Chest",upperBack:"Upper back",lowerBack:"Lower back",abdomen:"Abdomen",
shoulderL:"L Shoulder",shoulderR:"R Shoulder",upperArmF_L:"L Upper arm (ant)",upperArmF_R:"R Upper arm (ant)",
upperArmB_L:"L Upper arm (post)",upperArmB_R:"R Upper arm (post)",forearmF_L:"L Forearm (ant)",forearmF_R:"R Forearm (ant)",
forearmB_L:"L Forearm (post)",forearmB_R:"R Forearm (post)",handL:"L Hand",handR:"R Hand",gluteL:"L Glute",gluteR:"R Glute",
thighF_L:"L Thigh (ant)",thighF_R:"R Thigh (ant)",thighB_L:"L Thigh (post)",thighB_R:"R Thigh (post)",
thighM_L:"L Thigh (med)",thighM_R:"R Thigh (med)",thighL_L:"L Thigh (lat)",thighL_R:"R Thigh (lat)",
calfF_L:"L Lower leg (ant)",calfF_R:"R Lower leg (ant)",calfB_L:"L Lower leg (post)",calfB_R:"R Lower leg (post)",
itb_L:"L ITB zone",itb_R:"R ITB zone",achilles_L:"L Achilles",achilles_R:"R Achilles",
footSole_L:"L Sole",footSole_R:"R Sole",footDorsum_L:"L Dorsum",footDorsum_R:"R Dorsum",
hipRing_L:"L Hip ring",hipRing_R:"R Hip ring",kneeRing_L:"L Knee ring",kneeRing_R:"R Knee ring"},
toastSaved:"Saved",toastLoaded:"Loaded",front:"Front",back:"Back"}};
let LANG='ja';const $=s=>document.querySelector(s);const toast=m=>{const t=$("#toast");t.textContent=m;t.style.display="block";setTimeout(()=>t.style.display="none",1200)};
const ymd=d=>d.toISOString().slice(0,10);
const stage=$("#stage");
const renderer=new THREE.WebGLRenderer({antialias:true,alpha:true,preserveDrawingBuffer:true});
renderer.setPixelRatio(Math.min(devicePixelRatio,2));renderer.setSize(stage.clientWidth,stage.clientHeight);stage.appendChild(renderer.domElement);
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(45,stage.clientWidth/stage.clientHeight,.1,100);camera.position.set(0,1.6,4.2);
const controls=new THREE.OrbitControls(camera,renderer.domElement);controls.enableDamping=true;controls.target.set(0,1.3,0);controls.minDistance=2.2;controls.maxDistance=8;controls.enablePan=true;
scene.add(new THREE.HemisphereLight(0xbfd4ff,0x111318,.9));const dl=new THREE.DirectionalLight(0xffffff,.9);dl.position.set(2,3,2);scene.add(dl);
/* 外形 */
const skinMat=new THREE.MeshPhysicalMaterial({color:0xfff3e6,roughness:.9,transmission:.6,thickness:.4,transparent:true,opacity:.6});
const capsule=(r,h)=>new THREE.CapsuleGeometry(r,h,8,16);const box=(x,y,z)=>new THREE.BoxGeometry(x,y,z);
const skin=new THREE.Group();scene.add(skin);
const trunk=new THREE.Group();skin.add(trunk);
const head=new THREE.Mesh(capsule(.11,.22),skinMat);head.position.set(0,1.75,0);trunk.add(head);
const chest=new THREE.Mesh(capsule(.28,.45),skinMat);chest.position.set(0,1.35,0);trunk.add(chest);
const abdomen=new THREE.Mesh(capsule(.24,.32),skinMat);abdomen.position.set(0,1.02,0);trunk.add(abdomen);
const pelvis=new THREE.Mesh(capsule(.28,.25),skinMat);pelvis.position.set(0,.78,0);trunk.add(pelvis);
function arm(side){const s=side==='L'?-1:1;const g=new THREE.Group();skin.add(g);
  const ua=new THREE.Mesh(capsule(.09,.32),skinMat);ua.position.set(.35*s,1.35,0);ua.rotation.z=-Math.PI*.25*s;g.add(ua);
  const fa=new THREE.Mesh(capsule(.075,.30),skinMat);fa.position.set(.6*s,1.05,0);fa.rotation.z=-Math.PI*.3*s;g.add(fa);
  const hand=new THREE.Mesh(box(.12,.18,.04),skinMat);hand.position.set(.8*s,.86,0);hand.rotation.z=-Math.PI*.3*s;g.add(hand);}
arm('L');arm('R');
function leg(side){const s=side==='L'?-1:1;
  const th=new THREE.Mesh(capsule(.12,.42),skinMat);th.position.set(.14*s,.55,0);skin.add(th);
  const sh=new THREE.Mesh(capsule(.095,.40),skinMat);sh.position.set(.14*s,.15,0);skin.add(sh);
  const ft=new THREE.Mesh(box(.12,.05,.24),skinMat);ft.position.set(.14*s,-.07,.085);skin.add(ft);}
leg('L');leg('R');
/* 選択部位 */
const regionDefs=[{id:"head",geom:capsule(.105,.2),pos:[0,1.75,0]},{id:"neck",geom:capsule(.10,.10),pos:[0,1.58,0]},
{id:"chest",geom:capsule(.26,.42),pos:[0,1.34,0]},{id:"upperBack",geom:capsule(.26,.42),pos:[0,1.34,-.02]},
{id:"abdomen",geom:capsule(.22,.28),pos:[0,1.03,0]},{id:"lowerBack",geom:capsule(.22,.28),pos:[0,1.03,-.02]},
{id:"shoulderL",geom:capsule(.11,.12),pos:[-.33,1.42,0]},{id:"shoulderR",geom:capsule(.11,.12),pos:[.33,1.42,0]},
{id:"upperArmF_L",geom:capsule(.085,.28),pos:[-.48,1.23,.04],rot:[0,0,-Math.PI*.25]},
{id:"upperArmF_R",geom:capsule(.085,.28),pos:[ .48,1.23,.04],rot:[0,0, Math.PI*.25]},
{id:"upperArmB_L",geom:capsule(.085,.28),pos:[-.48,1.23,-.04],rot:[0,0,-Math.PI*.25]},
{id:"upperArmB_R",geom:capsule(.085,.28),pos:[ .48,1.23,-.04],rot:[0,0, Math.PI*.25]},
{id:"forearmF_L",geom:capsule(.07,.26),pos:[-.66,1.0,.02],rot:[0,0,-Math.PI*.3]},
{id:"forearmF_R",geom:capsule(.07,.26),pos:[ .66,1.0,.02],rot:[0,0, Math.PI*.3]},
{id:"forearmB_L",geom:capsule(.07,.26),pos:[-.66,1.0,-.02],rot:[0,0,-Math.PI*.3]},
{id:"forearmB_R",geom:capsule(.07,.26),pos:[ .66,1.0,-.02],rot:[0,0, Math.PI*.3]},
{id:"handL",geom:box(.10,.16,.05),pos:[-.83,.86,0]},{id:"handR",geom:box(.10,.16,.05),pos:[ .83,.86,0]},
{id:"gluteL",geom:capsule(.13,.18),pos:[-.15,.82,-.02]},{id:"gluteR",geom:capsule(.13,.18),pos:[ .15,.82,-.02]},
{id:"thighF_L",geom:capsule(.11,.38),pos:[-.14,.52,.05]},{id:"thighF_R",geom:capsule(.11,.38),pos:[ .14,.52,.05]},
{id:"thighB_L",geom:capsule(.11,.38),pos:[-.14,.52,-.05]},{id:"thighB_R",geom:capsule(.11,.38),pos:[ .14,.52,-.05]},
{id:"thighM_L",geom:capsule(.09,.36),pos:[-.07,.52,0]},{id:"thighM_R",geom:capsule(.09,.36),pos:[ .07,.52,0]},
{id:"thighL_L",geom:capsule(.09,.36),pos:[-.21,.52,0]},{id:"thighL_R",geom:capsule(.09,.36),pos:[ .21,.52,0]},
{id:"calfF_L",geom:capsule(.085,.35),pos:[-.14,.14,.04]},{id:"calfF_R",geom:capsule(.085,.35),pos:[ .14,.14,.04]},
{id:"calfB_L",geom:capsule(.085,.35),pos:[-.14,.14,-.04]},{id:"calfB_R",geom:capsule(.085,.35),pos:[ .14,.14,-.04]},
{id:"itb_L",geom:capsule(.06,.38),pos:[-.24,.52,0]},{id:"itb_R",geom:capsule(.06,.38),pos:[ .24,.52,0]},
{id:"achilles_L",geom:capsule(.04,.18),pos:[-.14,0,-.03]},{id:"achilles_R",geom:capsule(.04,.18),pos:[ .14,0,-.03]},
{id:"footSole_L",geom:box(.11,.04,.22),pos:[-.14,-.07,.085]},{id:"footSole_R",geom:box(.11,.04,.22),pos:[ .14,-.07,.085]},
{id:"footDorsum_L",geom:box(.11,.04,.22),pos:[-.14,-.07,.085],rot:[Math.PI,0,0]},
{id:"footDorsum_R",geom:box(.11,.04,.22),pos:[ .14,-.07,.085],rot:[Math.PI,0,0]},
{id:"hipRing_L",geom:capsule(.12,.10),pos:[-.14,.74,0]},{id:"hipRing_R",geom:capsule(.12,.10),pos:[ .14,.74,0]},
{id:"kneeRing_L",geom:capsule(.10,.10),pos:[-.14,.30,.02]},{id:"kneeRing_R",geom:capsule(.10,.10),pos:[ .14,.30,.02]}];
const picking=new THREE.Group();scene.add(picking);
const COLORS={none:0x5f738a,weak:'#F2C94C',mid:'#F2994A',strong:'#EB5757'};
const stripeCache={};function stripe(base,op=.18,period=12){const k=base+':'+op+':'+period;if(stripeCache[k])return stripeCache[k];
  const s=128,c=document.createElement('canvas');c.width=c.height=s;const x=c.getContext('2d');x.fillStyle=base;x.fillRect(0,0,s,s);x.globalAlpha=op;x.fillStyle='#fff';
  for(let i=-s;i<s*2;i+=period){x.beginPath();x.moveTo(i,0);x.lineTo(i+s*.5,0);x.lineTo(i,s);x.lineTo(i-s*.5,s);x.closePath();x.fill()}const t=new THREE.CanvasTexture(c);t.wrapS=t.wrapT=THREE.RepeatWrapping;return(stripeCache[k]=t);}
function mat(l){if(l===0)return new THREE.MeshStandardMaterial({color:COLORS.none,roughness:.9,transparent:true,opacity:.18});
if(l===1)return new THREE.MeshStandardMaterial({color:COLORS.weak,roughness:.8,transparent:true,opacity:.6});
if(l===2)return new THREE.MeshStandardMaterial({color:COLORS.mid,roughness:.7,transparent:true,opacity:.75,map:stripe(COLORS.mid,.16,14)});
return new THREE.MeshStandardMaterial({color:COLORS.strong,roughness:.6,transparent:true,opacity:.85,map:stripe(COLORS.strong,.22,10)})}
const regions={};for(const d of regionDefs){const m=new THREE.Mesh(d.geom,mat(0));m.position.fromArray(d.pos);if(d.rot)m.rotation.set(d.rot[0]||0,d.rot[1]||0,d.rot[2]||0);m.userData={id:d.id,level:0};picking.add(m);regions[d.id]=m;}
/* 入力 */
const ray=new THREE.Raycaster(),pt=new THREE.Vector2();let both=false,mirror=false;
const pair=id=>/_L$/.test(id)?id.replace(/_L$/,'_R'):/_R$/.test(id)?id.replace(/_R$/,'_L'):/L$/.test(id)?id.replace(/L$/,'R'):/R$/.test(id)?id.replace(/R$/,'L'):null;
const setLevel=(id,l)=>{const m=regions[id];if(!m)return;m.userData.level=l;m.material.dispose();m.material=mat(l);}
function cycle(id){const cur=regions[id].userData.level||0;const nxt=(cur+1)%4;setLevel(id,nxt);if(both){const p=pair(id);if(p)setLevel(p,nxt)}if(mirror){const p=pair(id);if(p)setLevel(p,regions[id].userData.level)}push();saveToday();toast((L10N[LANG].regions[id]||id));}
function tap(x,y){const r=renderer.domElement.getBoundingClientRect();pt.x=((x-r.left)/r.width)*2-1;pt.y=-((y-r.top)/r.height)*2+1;ray.setFromCamera(pt,camera);
  const hit=ray.intersectObjects(picking.children,false)[0];if(hit)cycle(hit.object.userData.id);}
renderer.domElement.addEventListener('pointerdown',e=>{if(e.isPrimary&&e.pointerType!=='mouse'&&e.width<=20&&e.height<=20)tap(e.clientX,e.clientY)});
renderer.domElement.addEventListener('dblclick',e=>tap(e.clientX,e.clientY));
/* ビュー/UI */
function setView(m){const seg=$("#viewSeg");seg.querySelectorAll('button').forEach(b=>b.classList.toggle('active',b.dataset.view===m));
  if(m==='front'){controls.target.set(0,1.3,0);camera.position.set(0,1.6,4.2)}else{controls.target.set(0,1.3,0);camera.position.set(0,1.6,-4.2)}controls.update()}
$("#viewSeg").addEventListener('click',e=>{if(e.target.tagName==='BUTTON')setView(e.target.dataset.view)});$("#bothBtn").onclick=()=>{both=!both;$("#bothBtn").classList.toggle('primary',both)}
$("#mirrorBtn").onclick=()=>{mirror=!mirror;$("#mirrorBtn").classList.toggle('primary',mirror)}
/* 履歴/保存 */
const KEY='muscle-map-daily';const hist=[];let hp=-1;
const snap=()=>{const s={};for(const id in regions)s[id]=regions[id].userData.level||0;return s}
const apply=s=>{for(const id in s)if(regions[id]!=null)setLevel(id,s[id])}
function push(){const s=snap();hist.splice(hp+1);hist.push(s);hp=hist.length-1}
function undo(){if(hp>0){hp--;apply(hist[hp]);saveToday()}}function redo(){if(hp<hist.length-1){hp++;apply(hist[hp]);saveToday()}}
$("#undoBtn").onclick=undo;$("#redoBtn").onclick=redo;
const loadAll=()=>{try{const r=localStorage.getItem(KEY);return r?JSON.parse(r):{}}catch{return{}}}
const saveAll=o=>{try{localStorage.setItem(KEY,JSON.stringify(o))}catch{}}
const saveToday=(d=ymd(new Date()))=>{const all=loadAll();all[d]=snap();saveAll(all);if($("#calendarPanel").classList.contains('open'))renderCal()}
const loadDate=d=>{const all=loadAll();if(all[d]){apply(all[d]);push();toast(L10N[LANG].toastLoaded)}}
/* カレンダー */
const cal=$("#calendarPanel"),grid=$("#calGrid");let cur=new Date();
$("#calendarBtn").onclick=()=>cal.classList.toggle('open');$("#calPrev").onclick=()=>{cur.setMonth(cur.getMonth()-1);renderCal()};$("#calNext").onclick=()=>{cur.setMonth(cur.getMonth()+1);renderCal()}
function renderCal(){const y=cur.getFullYear(),m=cur.getMonth();$("#calTitle").textContent=`${y} / ${('0'+(m+1)).slice(-2)}`;grid.innerHTML='';
  const first=new Date(y,m,1),start=(first.getDay()+6)%7,days=new Date(y,m+1,0).getDate(),wd=['日','月','火','水','木','金','土'];
  for(let i=0;i<7;i++){const h=document.createElement('div');h.className='calCell';h.style.fontWeight='700';h.textContent=wd[i];grid.appendChild(h)}
  for(let i=0;i<start;i++){const d=document.createElement('div');d.className='calCell';d.style.opacity=.3;grid.appendChild(d)}
  const all=loadAll(),today=ymd(new Date());
  for(let d=1;d<=days;d++){const el=document.createElement('div');el.className='calCell';const key=ymd(new Date(y,m,d));el.textContent=d;
    if(key===today)el.classList.add('today');if(all[key])el.classList.add('hasData');el.onclick=()=>{loadDate(key);cal.classList.remove('open')};grid.appendChild(el)}}
/* I/O & 言語 */
$("#lang").addEventListener('click',e=>{if(e.target.tagName!=='BUTTON')return;$("#lang").querySelectorAll('button').forEach(b=>b.classList.remove('active'));e.target.classList.add('active');LANG=e.target.dataset.lang;
  const vs=$("#viewSeg").querySelectorAll('button');vs[0].textContent=L10N[LANG].front;vs[1].textContent=L10N[LANG].back;});
$("#exportBtn").onclick=()=>{const data={version:1,date:ymd(new Date()),state:snap()},blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob),a=document.createElement('a');a.href=url;a.download=`musclemap_${data.date}.json`;a.click();URL.revokeObjectURL(url)}
$("#importBtn").onclick=()=>{const inp=document.createElement('input');inp.type='file';inp.accept='application/json';inp.onchange=()=>{const f=inp.files[0];if(!f)return;const fr=new FileReader();
  fr.onload=()=>{try{const j=JSON.parse(fr.result);if(j&&j.state){apply(j.state);push();toast(L10N[LANG].toastLoaded)}}catch{}};fr.readAsText(f)};inp.click()}
$("#shotBtn").onclick=()=>{renderer.render(scene,camera);const url=renderer.domElement.toDataURL('image/png');const a=document.createElement('a');a.href=url;a.download=`snapshot_${ymd(new Date())}.png`;a.click()}
window.addEventListener('resize',()=>{renderer.setSize(stage.clientWidth,stage.clientHeight);camera.aspect=stage.clientWidth/stage.clientHeight;camera.updateProjectionMatrix()});
/* 起動 */
function init(){setView('front');renderCal();push();const today=ymd(new Date()),all=loadAll();if(all[today]){apply(all[today]);push()}}
init();(function loop(){requestAnimationFrame(loop);controls.update();renderer.render(scene,camera)})();
</script></body></html>